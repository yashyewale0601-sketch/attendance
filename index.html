<!DOCTYPE html>
<html>
<head>
  <title>Student Attendance System</title>

  <!-- QR Code Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Excel Export Library (SheetJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial; margin: 40px; }
    #qr { margin-top: 20px; }
    .box { padding: 20px; border: 1px solid #ccc; border-radius: 10px; width: 350px; }
    input, select, button { width: 100%; padding: 8px; margin-top: 10px; }
    button { background: black; color: white; border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>

<body>

  <!-- ADMIN PAGE -->
  <div id="adminPage" class="box">
    <h2>Generate QR for Event</h2>

    <label>Select Event:</label>
    <select id="eventSelect">
      <option value="python_workshop">Python Workshop</option>
      <option value="cloud_computing">Cloud Computing Seminar</option>
      <option value="ai_session">AI Intro Session</option>
    </select>

    <button onclick="generateQR()">Generate QR Code</button>

    <div id="qr"></div>
    <p id="qrLink"></p>

    <hr>

    <button onclick="downloadExcel()">Download Attendance Excel</button>
  </div>

  <!-- STUDENT FORM PAGE -->
  <div id="formPage" class="box" style="display:none;">
    <h2>Student Attendance Form</h2>

    <label>Roll No:</label>
    <input type="text" id="roll">

    <label>Name:</label>
    <input type="text" id="name">

    <label>Division:</label>
    <input type="text" id="div">

    <button onclick="submitForm()">Submit Attendance</button>

    <p id="status" style="color:green;"></p>
  </div>


<script>
// --- Supabase config with your credentials ---
const SUPABASE_URL = "https://qdfwzuttffkpitplisop.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkZnd6dXR0ZmZrcGl0cGxpc29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzQ3NzMsImV4cCI6MjA3ODUxMDc3M30.ruo0v0XVE5RvUn_nvL0VlZwg3eh2VJnN2K_-0eCBWOI";

const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_KEY);

// 1. Generate QR code for selected event
function generateQR() {
  const eventId = document.getElementById("eventSelect").value;

  // Build link for student
  let scanURL = window.location.origin + window.location.pathname +
    "?form=1&event=" + encodeURIComponent(eventId);

  document.getElementById("qr").innerHTML = "";
  new QRCode(document.getElementById("qr"), scanURL);

  document.getElementById("qrLink").innerHTML = "<b>Scan URL:</b> " + scanURL;
}

// 2. On page load, check if student form should show
const params = new URLSearchParams(window.location.search);
if (params.get("form") === "1") {
  document.getElementById("adminPage").style.display = "none";
  document.getElementById("formPage").style.display = "block";
  window.currentEvent = params.get("event");
}

// 3. Submit attendance
async function submitForm() {
  const roll = document.getElementById("roll").value;
  const name = document.getElementById("name").value;
  const division = document.getElementById("div").value;

  if (!roll || !name || !division) {
    alert("Please fill all fields.");
    return;
  }

  const { error } = await supabase
    .from("attendance")
    .insert([{ event: window.currentEvent, roll_no: roll, name: name, division: division }]);

  if (error) {
    alert("Error: " + error.message);
  } else {
    document.getElementById("status").innerText = "Attendance Submitted!";
  }
}

// 4. Download Excel of attendance
async function downloadExcel() {
  const { data, error } = await supabase
    .from("attendance")
    .select("*");

  if (error) {
    alert("Error fetching data: " + error.message);
    return;
  }
  if (!data || data.length === 0) {
    alert("No attendance to export.");
    return;
  }

  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Attendance");
  XLSX.writeFile(workbook, "attendance.xlsx");
}
</script>

</body>
</html>
