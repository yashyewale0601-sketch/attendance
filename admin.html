<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Admin Panel ‚Äî Attendance System</title>

<!-- QR Generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Excel Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body{
    margin:0;
    font-family:"Poppins",sans-serif;
    background:#eef1f7;
    padding:20px;
    animation:fadeIn 0.5s ease;
  }

  @keyframes fadeIn {
    from{opacity:0; transform:translateY(10px);}
    to{opacity:1; transform:translateY(0);}
  }

  .card{
    background:white;
    padding:25px;
    max-width:900px;
    margin:auto;
    border-radius:14px;
    box-shadow:0 10px 25px rgba(0,0,0,0.08);
    transition:0.3s ease;
  }

  input,button{
    width:100%;
    padding:12px;
    margin-top:10px;
    border-radius:10px;
    border:1px solid #d1d5db;
    font-size:15px;
    transition:0.2s;
  }

  input:focus{
    border-color:#6366f1;
    box-shadow:0 0 5px rgba(99,102,241,0.3);
  }

  button{
    background:#111827;
    color:white;
    font-weight:600;
    cursor:pointer;
  }

  button:hover{
    background:#1f2937;
    transform:scale(1.02);
  }

  .danger{
    background:#dc2626!important;
  }

  .danger:hover{
    background:#b91c1c!important;
  }

  table{
    width:100%;
    margin-top:20px;
    border-collapse:collapse;
  }

  th,td{
    padding:12px;
    border-bottom:1px solid #e5e7eb;
    text-align:left;
  }

  #eventsTable{
    overflow-x:auto;
    display:block;
  }

  #qrArea{
    margin-top:25px;
    text-align:center;
    animation:fadeIn 0.3s ease;
  }

  #qrcode{
    margin:auto;
  }

  .hidden{
    display:none;
  }
</style>

</head>
<body>

<div class="card">
  <h1>Admin Panel üîê</h1>

  <!-- LOGIN -->
  <div id="loginSection">
    <h3>Admin Login</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>

  <!-- ADMIN -->
  <div id="adminSection" class="hidden">
    <h3>Logged in as <span id="adminMail"></span></h3>
    <button id="logoutBtn" class="danger">Logout</button>

    <h2>Create Event</h2>
    <input id="eventTitle" placeholder="Event Title">
    <input id="eventDate" type="date">
    <button id="createEventBtn">Create</button>

    <div id="qrArea" class="hidden">
      <h3>QR Code</h3>
      <div id="qrcode"></div>
      <p id="qrLink"></p>
    </div>

    <h2>Past Events</h2>
    <div id="eventsTable">
      <table>
        <thead>
          <tr><th>Event</th><th>Date</th><th>QR</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h2>Export Attendance</h2>
    <button id="exportBtn">Download Excel</button>
  </div>
</div>

<script>
/* SUPABASE */
const SUPABASE_URL = "https://qdfwzuttffkpitplisop.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFkZnd6dXR0ZmZrcGl0cGxpc29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MzQ3NzMsImV4cCI6MjA3ODUxMDc3M30.ruo0v0XVE5RvUn_nvL0VlZwg3eh2VJnN2K_-0eCBWOI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const ADMIN_EMAIL = "yash.admin@gmail.com";

const loginSection = document.getElementById("loginSection");
const adminSection = document.getElementById("adminSection");
const adminMail = document.getElementById("adminMail");

/* LOGIN */
document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  const { data, error } = await supa.auth.signInWithPassword({ email, password });

  if(error) return alert("Login failed: " + error.message);

  if(data.user.email !== ADMIN_EMAIL) {
    alert("Not Admin!");
    await supa.auth.signOut();
    return;
  }

  loginSection.classList.add("hidden");
  adminSection.classList.remove("hidden");
  adminMail.textContent = data.user.email;

  loadEvents();
};

/* LOGOUT */
document.getElementById("logoutBtn").onclick = async () => {
  await supa.auth.signOut();
  location.reload();
};

/* CREATE EVENT */
document.getElementById("createEventBtn").onclick = async () => {
  const title = document.getElementById("eventTitle").value.trim();
  const date = document.getElementById("eventDate").value;

  if(!title) return alert("Enter title");

  const { data, error } = await supa.from("events").insert([{ title, event_date: date }]).select().single();

  if(error) return alert(error.message);

  showQR(data.id);
  loadEvents();
};

/* SHOW QR */
function showQR(id){
  const url = location.origin + "/student.html?event=" + id;

  document.getElementById("qrArea").classList.remove("hidden");
  document.getElementById("qrcode").innerHTML = "";
  new QRCode(document.getElementById("qrcode"), url);
  document.getElementById("qrLink").innerText = url;
}

/* LOAD EVENTS */
async function loadEvents(){
  const { data } = await supa.from("events").select("*");

  const tbody = document.querySelector("tbody");
  tbody.innerHTML = "";

  data.forEach(ev=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${ev.title}</td>
      <td>${ev.event_date || ""}</td>
      <td><button onclick="showQR('${ev.id}')">QR</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* EXPORT */
document.getElementById("exportBtn").onclick = async () => {
  const attendance = await supa.from("attendance").select("*");
  const events = await supa.from("events").select("*");

  let rows = attendance.data.map(a=>{
    const ev = events.data.find(e=>e.id===a.event_id);
    return {
      Event: ev?.title || "",
      Name: a.name,
      Division: a.division,
      Roll: a.roll_no,
      Email: a.email,
      Date: a.created_at
    };
  });

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Attendance");
  XLSX.writeFile(wb, "Attendance.xlsx");
};

window.onload = async()=>{
  const { data } = await supa.auth.getSession();
  if(data.session?.user?.email === ADMIN_EMAIL){
    loginSection.classList.add("hidden");
    adminSection.classList.remove("hidden");
    adminMail.textContent=data.session.user.email;
    loadEvents();
  }
};
</script>

</body>
</html>

