<!DOCTYPE html>
<html>
<head>
<title>Admin Panel</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
body{font-family:Arial;background:#f4f4f4;padding:20px}
.box{background:#fff;padding:20px;border-radius:10px;width:500px;margin:auto}
input,button{padding:10px;width:100%;margin:6px 0}
button{background:#007bff;color:#fff;border:none;font-weight:bold;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px}
td,th{border:1px solid #ccc;padding:8px}
</style>
</head>
<body>

<div class="box">
<h2>Admin Panel</h2>

<label>Supabase URL</label>
<input id="url">

<label>Supabase Key</label>
<input id="key">

<label>Event Title</label>
<input id="eventTitle">

<button onclick="createEvent()">Create Event + Generate QR</button>

<div id="qr"></div>
<p id="eventLink"></p>

<h3>All Events</h3>
<table>
    <thead><tr><th>Event</th><th>Form Link</th></tr></thead>
    <tbody id="eventList"></tbody>
</table>

<button onclick="downloadCSV()">Export Excel (CSV)</button>

</div>

<script>
let supabase;

function init(){
    supabase = supabasejs.createClient(
        document.getElementById("url").value,
        document.getElementById("key").value
    );
}

async function createEvent(){
    init();
    let title = document.getElementById("eventTitle").value;

    let { data } = await supabase.from("events").insert([{ title }]).select();
    let id = data[0].id;

    let link = "student.html?event_id=" + id;

    document.getElementById("eventLink").innerText = link;

    new QRCode(document.getElementById("qr"), link);

    loadEvents();
}

async function loadEvents(){
    init();
    let { data } = await supabase.from("events").select("*");

    let html = "";
    data.forEach(e=>{
        html += `<tr>
            <td>${e.title}</td>
            <td><a href="student.html?event_id=${e.id}">Open Form</a></td>
        </tr>`;
    });

    document.getElementById("eventList").innerHTML = html;
}

async function downloadCSV(){
    init();
    let { data } = await supabase.from("attendance").select("*");

    let csv = "event_id,roll_no,name,division,created_at\n";
    data.forEach(r=>{
        csv += `${r.event_id},${r.roll_no},${r.name},${r.division},${r.created_at}\n`;
    });

    let blob = new Blob([csv], {type:"text/csv"});
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "attendance.csv";
    link.click();
}
</script>

</body>
</html>
